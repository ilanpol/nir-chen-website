<!-- קוד תפריט נגישות משופר -->
<div class="accessibility-widget" role="button" tabindex="0" aria-label="פתיחת תפריט נגישות" aria-expanded="false" aria-controls="accessibility-menu" id="accessibility-toggle-button">
    <i class="fas fa-universal-access" aria-hidden="true"></i>
    <span class="sr-only">פתח תפריט נגישות</span>
</div>

<div class="accessibility-menu" id="accessibility-menu" role="dialog" aria-labelledby="accessibility-dialog-title">
    <h3 id="accessibility-dialog-title" class="text-lg font-bold text-blue-900 mb-4">הגדרות נגישות</h3>
    <div class="space-y-3">
        <div class="flex items-center">
            <input class="ml-2" id="font-large" type="checkbox" aria-describedby="font-large-desc">
            <label for="font-large">הגדלת גופן</label>
            <span id="font-large-desc" class="sr-only">לחץ כדי להגדיל את גודל הטקסט באתר</span>
        </div>
        <div class="flex items-center">
            <input class="ml-2" id="high-contrast" type="checkbox" aria-describedby="high-contrast-desc">
            <label for="high-contrast">ניגודיות גבוהה</label>
            <span id="high-contrast-desc" class="sr-only">הגברת ניגודיות הצבעים לשיפור קריאה</span>
        </div>
        <div class="flex items-center">
            <input class="ml-2" id="grayscale" type="checkbox" aria-describedby="grayscale-desc">
            <label for="grayscale">גווני אפור</label>
            <span id="grayscale-desc" class="sr-only">הצגת האתר בגווני שחור-לבן</span>
        </div>
        <div class="flex items-center">
            <input class="ml-2" id="links-underline" type="checkbox" aria-describedby="links-underline-desc">
            <label for="links-underline">הדגשת קישורים</label>
            <span id="links-underline-desc" class="sr-only">הוספת קו תחתון לכל הקישורים באתר</span>
        </div>
        <div class="flex items-center">
            <input class="ml-2" id="read-mode" type="checkbox" aria-describedby="read-mode-desc">
            <label for="read-mode">מצב קריאה</label>
            <span id="read-mode-desc" class="sr-only">הצגת האתר במצב קריאה עם פחות הסחות דעת</span>
        </div>
        <div class="mt-4">
            <button id="reset-accessibility" class="bg-blue-900 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition-all w-full">
                איפוס הגדרות
            </button>
        </div>
    </div>
</div>

<!-- סגנונות CSS משופרים לנגישות -->
<style>
    /* סגנונות בסיסיים לתפריט הנגישות */
    .accessibility-widget {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 50px;
        height: 50px;
        background-color: #0c4a6e;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 998;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .accessibility-widget:hover,
    .accessibility-widget:focus {
        background-color: #075985;
        border: 2px solid white;
        outline: none;
    }

    .accessibility-menu {
        position: fixed;
        bottom: 80px;
        left: 20px;
        width: 280px;
        background-color: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 999;
        display: none;
        transition: all 0.3s ease;
        border: 2px solid #0c4a6e;
    }

    .accessibility-menu.show {
        display: block;
    }

    /* סגנונות עבור אפשרויות הנגישות */
    .large-font {
        font-size: 120% !important;
    }

    .large-font h1, .large-font h2, .large-font h3, .large-font h4 {
        font-size: 130% !important;
    }

    .large-font p, .large-font li, .large-font label, .large-font input, .large-font textarea, .large-font button {
        font-size: 120% !important;
        line-height: 1.5 !important;
    }

    .high-contrast {
        filter: contrast(150%);
        background-color: black !important;
        color: white !important;
    }

    .high-contrast a, .high-contrast button, .high-contrast h1, 
    .high-contrast h2, .high-contrast h3, .high-contrast h4 {
        color: yellow !important;
    }

    .high-contrast input, .high-contrast textarea {
        background-color: #333 !important;
        color: white !important;
        border-color: yellow !important;
    }

    .grayscale {
        filter: grayscale(100%);
    }

    .links-underline a {
        text-decoration: underline !important;
        text-decoration-thickness: 2px !important;
    }
    
    .read-mode .container {
        max-width: 800px !important;
        margin: 0 auto !important;
    }
    
    .read-mode .hero-gradient, 
    .read-mode footer,
    .read-mode section:not(#main-content) {
        display: none !important;
    }
    
    .read-mode #main-content {
        padding: 40px 20px !important;
        background-color: #fff !important;
        color: #333 !important;
    }
    
    .read-mode body {
        background-color: #f5f5f5 !important;
    }

    /* הוספת פוקוס ברור לכל האלמנטים האינטראקטיביים */
    a:focus, button:focus, input:focus, textarea:focus, select:focus, [role="button"]:focus {
        outline: 3px solid #4299e1 !important;
        outline-offset: 2px !important;
    }
    
    /* סגנון חדש לתפריט נייד מונגש */
    .mobile-menu.open {
        display: block;
        max-height: 1000px;
        transition: max-height 0.5s ease-in-out;
    }
    
    .mobile-menu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out;
    }
    
    /* השיפור עבור מקלדת */
    .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #0c4a6e;
        color: white;
        padding: 8px;
        z-index: 9999;
        transition: top 0.3s;
    }
    
    .skip-link:focus {
        top: 0;
    }
    
    /* הסרת אנימציות עבור משתמשים שמעדיפים פחות תנועה */
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
        
        .animate__animated {
            animation: none !important;
        }
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        white-space: nowrap;
        border: 0;
    }
</style>

<!-- JavaScript משופר לנגישות -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // קישור מהיר לדילוג על ניווט
        const skipLink = document.createElement('a');
        skipLink.href = '#main-content';
        skipLink.className = 'skip-link';
        skipLink.innerText = 'דלג לתוכן העיקרי';
        document.body.prepend(skipLink);
        
        // הוספת ID לתוכן העיקרי
        const mainContent = document.querySelector('#home') || document.querySelector('section:first-of-type');
        if (mainContent) {
            mainContent.id = 'main-content';
        }
        
        // תפריט נגישות
        const accessibilityWidget = document.querySelector('.accessibility-widget');
        const accessibilityMenu = document.getElementById('accessibility-menu');
        
        // פונקציונליות פתיחה וסגירה של תפריט
        if (accessibilityWidget && accessibilityMenu) {
            accessibilityWidget.addEventListener('click', function() {
                const isExpanded = accessibilityMenu.classList.contains('show');
                accessibilityMenu.classList.toggle('show');
                accessibilityWidget.setAttribute('aria-expanded', !isExpanded);
                
                // אם התפריט נפתח, התמקד בכותרת שלו
                if (!isExpanded) {
                    const title = document.getElementById('accessibility-dialog-title');
                    if (title) {
                        title.focus();
                    }
                }
            });
            
            // סגירת התפריט בלחיצה מחוץ לו
            document.addEventListener('click', function(event) {
                if (!accessibilityMenu.contains(event.target) && 
                    !accessibilityWidget.contains(event.target) &&
                    accessibilityMenu.classList.contains('show')) {
                    accessibilityMenu.classList.remove('show');
                    accessibilityWidget.setAttribute('aria-expanded', 'false');
                    accessibilityWidget.focus(); // החזרת הפוקוס לכפתור
                }
            });
            
            // טיפול במקש Escape לסגירת התפריט
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && accessibilityMenu.classList.contains('show')) {
                    accessibilityMenu.classList.remove('show');
                    accessibilityWidget.setAttribute('aria-expanded', 'false');
                    accessibilityWidget.focus(); // החזרת הפוקוס לכפתור
                }
            });
        }
        
        // פונקציונאליות אפשרויות הנגישות
        const fontLarge = document.getElementById('font-large');
        const highContrast = document.getElementById('high-contrast');
        const grayscale = document.getElementById('grayscale');
        const linksUnderline = document.getElementById('links-underline');
        const readMode = document.getElementById('read-mode');
        const resetButton = document.getElementById('reset-accessibility');
        
        // טעינת הגדרות מהאחסון המקומי
        loadAccessibilitySettings();
        
        // הגדלת גופן
        if (fontLarge) {
            fontLarge.addEventListener('change', function() {
                document.body.classList.toggle('large-font', this.checked);
                saveSettings('large-font', this.checked);
            });
        }
        
        // ניגודיות גבוהה
        if (highContrast) {
            highContrast.addEventListener('change', function() {
                document.body.classList.toggle('high-contrast', this.checked);
                saveSettings('high-contrast', this.checked);
            });
        }
        
        // גווני אפור
        if (grayscale) {
            grayscale.addEventListener('change', function() {
                document.body.classList.toggle('grayscale', this.checked);
                saveSettings('grayscale', this.checked);
            });
        }
        
        // הדגשת קישורים
        if (linksUnderline) {
            linksUnderline.addEventListener('change', function() {
                document.body.classList.toggle('links-underline', this.checked);
                saveSettings('links-underline', this.checked);
            });
        }
        
        // מצב קריאה
        if (readMode) {
            readMode.addEventListener('change', function() {
                document.body.classList.toggle('read-mode', this.checked);
                saveSettings('read-mode', this.checked);
            });
        }
        
        // איפוס הגדרות
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                resetAccessibilitySettings();
            });
        }
        
        // פונקציה לשמירת הגדרות באחסון המקומי
        function saveSettings(key, value) {
            localStorage.setItem('accessibility_' + key, value);
        }
        
        // פונקציה לטעינת הגדרות מהאחסון המקומי
        function loadAccessibilitySettings() {
            if (fontLarge) {
                const largeFontSetting = localStorage.getItem('accessibility_large-font') === 'true';
                fontLarge.checked = largeFontSetting;
                document.body.classList.toggle('large-font', largeFontSetting);
            }
            
            if (highContrast) {
                const highContrastSetting = localStorage.getItem('accessibility_high-contrast') === 'true';
                highContrast.checked = highContrastSetting;
                document.body.classList.toggle('high-contrast', highContrastSetting);
            }
            
            if (grayscale) {
                const grayscaleSetting = localStorage.getItem('accessibility_grayscale') === 'true';
                grayscale.checked = grayscaleSetting;
                document.body.classList.toggle('grayscale', grayscaleSetting);
            }
            
            if (linksUnderline) {
                const linksUnderlineSetting = localStorage.getItem('accessibility_links-underline') === 'true';
                linksUnderline.checked = linksUnderlineSetting;
                document.body.classList.toggle('links-underline', linksUnderlineSetting);
            }
            
            if (readMode) {
                const readModeSetting = localStorage.getItem('accessibility_read-mode') === 'true';
                readMode.checked = readModeSetting;
                document.body.classList.toggle('read-mode', readModeSetting);
            }
        }
        
        // פונקציה לאיפוס כל ההגדרות
        function resetAccessibilitySettings() {
            // איפוס תצוגת האתר
            document.body.classList.remove('large-font', 'high-contrast', 'grayscale', 'links-underline', 'read-mode');
            
            // איפוס checkboxes
            if (fontLarge) fontLarge.checked = false;
            if (highContrast) highContrast.checked = false;
            if (grayscale) grayscale.checked = false;
            if (linksUnderline) linksUnderline.checked = false;
            if (readMode) readMode.checked = false;
            
            // מחיקת כל ההגדרות מהאחסון המקומי
            localStorage.removeItem('accessibility_large-font');
            localStorage.removeItem('accessibility_high-contrast');
            localStorage.removeItem('accessibility_grayscale');
            localStorage.removeItem('accessibility_links-underline');
            localStorage.removeItem('accessibility_read-mode');
            
            // הודעה למשתמש
            alert('הגדרות הנגישות אופסו בהצלחה');
        }
        
        // שיפור נגישות לשאלות נפוצות (FAQ)
        const faqQuestions = document.querySelectorAll('.faq-question');
        faqQuestions.forEach((question, index) => {
            const answer = question.nextElementSibling;
            const id = 'faq-answer-' + index;
            
            // הוספת ARIA attributes
            answer.id = id;
            question.setAttribute('aria-expanded', 'false');
            question.setAttribute('aria-controls', id);
            question.setAttribute('role', 'button');
            question.setAttribute('tabindex', '0');
            
            // טיפול באירועי מקש
            question.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    question.click();
                }
            });
            
            // עדכון האירוע click
            question.addEventListener('click', function() {
                const isExpanded = answer.classList.contains('hidden');
                const icon = this.querySelector('.faq-icon');
                
                answer.classList.toggle('hidden', !isExpanded);
                this.setAttribute('aria-expanded', isExpanded);
                
                if (icon) {
                    icon.classList.toggle('fa-chevron-down', !isExpanded);
                    icon.classList.toggle('fa-chevron-up', isExpanded);
                }
            });
        });
        
        // שיפור נגישות לתפריט הנייד
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.setAttribute('aria-expanded', 'false');
            mobileMenuButton.setAttribute('aria-controls', 'mobile-menu');
            mobileMenuButton.setAttribute('aria-label', 'פתח תפריט');
            
            mobileMenuButton.addEventListener('click', function() {
                const isExpanded = mobileMenu.classList.contains('open');
                mobileMenu.classList.toggle('open');
                this.setAttribute('aria-expanded', !isExpanded);
                this.setAttribute('aria-label', isExpanded ? 'פתח תפריט' : 'סגור תפריט');
            });
        }
        
        // שיפור נגישות מחשבון
        const calculateButton = document.getElementById('calculate-button');
        if (calculateButton) {
            calculateButton.setAttribute('aria-controls', 'calculation-results');
            
            // הוספת aria-live לתוצאות
            const resultsArea = document.createElement('div');
            resultsArea.id = 'calculation-results';
            resultsArea.setAttribute('aria-live', 'polite');
            resultsArea.setAttribute('role', 'region');
            resultsArea.setAttribute('aria-label', 'תוצאות החישוב');
            
            // הוספת האלמנט לאחר כפתור החישוב
            if (calculateButton.parentNode) {
                calculateButton.parentNode.appendChild(resultsArea);
            }
            
            // שכתוב פונקציית החישוב
            window.calculateCheck = function() {
                const checkAmount = parseFloat(document.getElementById('check-amount').value);
                const checkDate = new Date(document.getElementById('check-date').value);
                const today = new Date();
                
                // אימות קלט
                if (isNaN(checkAmount) || !checkDate || isNaN(checkDate.getTime())) {
                    alert('נא להזין סכום ותאריך תקינים');
                    return;
                }
                
                if (checkDate <= today) {
                    alert('תאריך הפירעון חייב להיות בעתיד');
                    return;
                }
                
                // חישובים כרגיל...
                const adjustedCheckDate = new Date(checkDate);
                adjustedCheckDate.setDate(adjustedCheckDate.getDate() + 4);
                
                const daysDifference = Math.ceil((adjustedCheckDate - today) / (1000 * 60 * 60 * 24));
                const monthsDifference = daysDifference / 30;
                
                const ratePerMonth = 0.02;
                const handlingFee = 100;
                const interestAmount = checkAmount * ratePerMonth * monthsDifference;
                const totalCommission = interestAmount + handlingFee;
                
                const netAmount = checkAmount - totalCommission;
                
                // עדכון התוצאות הגלויות
                document.getElementById('commission-result').textContent = '₪' + totalCommission.toFixed(0);
                document.getElementById('net-amount-result').textContent = '₪' + netAmount.toFixed(0);
                document.getElementById('days-saved-result').textContent = daysDifference;
                
                // עדכון אזור ה-ARIA Live
                const resultsText = `עמלה: ${totalCommission.toFixed(0)} ש"ח, סכום נטו: ${netAmount.toFixed(0)} ש"ח, ימי המתנה שנחסכו: ${daysDifference}`;
                document.getElementById('calculation-results').textContent = resultsText;
            };
        }
    });
</script>
